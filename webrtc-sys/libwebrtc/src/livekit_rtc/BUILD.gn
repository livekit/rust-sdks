import("../webrtc.gni")

if (is_android) {
  import("//build/config/android/config.gni")
  import("//build/config/android/rules.gni")
} else if (is_mac) {
  import("//build/config/mac/rules.gni")
} else if (is_ios) {
  import("//build/config/ios/rules.gni")
} else if (is_linux) {
  import("//build/config/linux/pkg_config.gni")
}

lk_sources = [
  "apm.cc",
  "peer.cc",
  "audio_device.cc",
  "transceiver.cc",
  "utils.cc",
  "data_channel.cc",
  "capi.cc",
  "video_encoder_factory.cc",
  "video_decoder_factory.cc",
  "video_track.cc",
  "video_frame.cc",
  "video_frame_buffer.cc",
  "session_description.cc",
  "ice_candidate.cc",
  "global_task_queue.cc",
  "audio_track.cc",
  "media_stream.cc",
  "media_stream_track.cc",
  "rtc_error.cc",
  "audio_resampler.cc",
  #"rtp_sender.cc",
  #"desktop_capturer.cc",
  "yuv_helper.cc",
  "rtp_parameters.cc",
]

if (is_mac) {
  lk_sources += [
    "objc_video_factory.mm",
    "objc_video_frame_buffer.mm",
  ]
}

if(is_android) {
  lk_sources += [
    "android.cc",
  ]
}

config("livekit_config") {
  include_dirs = [ "." ]
}

rtc_shared_library("livekit_rtc") {
  libs = []
  sources = lk_sources
  defines = [
    "USE_LIBYUV",
    "WEBRTC_INCLUDE_INTERNAL_AUDIO_DEVICE",
    "WEBRTC_APM_DEBUG_DUMP=0",
  ]
  cflags_cc = ["-Wno-sign-compare"]
  public_configs = [ ":livekit_config" ]

  deps = [
    "../api:create_peerconnection_factory",
    "../api:libjingle_peerconnection_api",
    "../api/audio_codecs:builtin_audio_decoder_factory",
    "../api/audio_codecs:builtin_audio_encoder_factory",
    "../api/crypto:frame_crypto_transformer",
    "../api/video:video_frame",
    "../api/video_codecs:builtin_video_decoder_factory",
    "../api/video_codecs:builtin_video_encoder_factory",
    "../media:rtc_audio_video",
    "../media:rtc_internal_video_codecs",
    "../media:rtc_media",
    "../media:rtc_media_base",
    "../modules/audio_device:audio_device",
    "../modules/audio_processing:api",
    "../modules/audio_processing:audio_processing",
    "../modules/video_capture:video_capture_module",
    "../pc:libjingle_peerconnection",
    "../rtc_base:threading",
    "../sdk:media_constraints",
    "//third_party/abseil-cpp/absl/memory",
    "//third_party/boringssl:boringssl",
    "//third_party/libyuv",
  ]

  if (is_mac) {
    deps += [
      "../sdk:peerconnectionfactory_base_objc",
      "../sdk:default_codec_factory_objc",
    ]
  }
}

rtc_test("livekit_rtc_unittests") {
    testonly = true

    sources = [
      "peer.test.cc",
    ]

    deps = [
      ":livekit_rtc",
      "//testing/gtest",
      "//test:test_support",
      "//test:test_main",
    ]
  }
